# 試合シミュレーション アルゴリズム概要

## 全体構成

`MatchSimulatorController`（partial class）が試合シミュレーションのメインコントローラー。
以下のPartialクラスに機能を分割している。

| Partialクラス | 役割 |
|---|---|
| PartialBallFlight | ボール飛行・着地・ルーズボール処理 |
| PartialKickoff | キックオフのセットアップと実行 |
| PartialPass | パス（通常・キックオフ） |
| PartialShoot | シュートとGKセーブ |
| PartialDribble | ドリブルと競り合い（デュエル） |
| PartialClear | クリア（自陣からの大きな蹴り出し） |
| PartialSetPlay | ラインアウト再開（スローイン、CK、GK、FK、PK） |
| PartialHelpers | 汎用ユーティリティ（選手検索、パスコース生成等） |

### 主要クラス

| クラス | 役割 |
|---|---|
| MatchState | 試合全体の状態管理（スコア、攻撃側チーム、トランジション凍結） |
| Ball | ボールの位置・状態（HOLD/FLYING/LOOSE）と飛行パス管理 |
| Player | 選手の位置・意図座標・ステータス・競り合い状態 |
| Team | チーム情報（選手リスト、フォーメーション配置） |
| GridEvaluator | グリッド上の評価（視野判定、パス/シュート判定、確率ロール） |
| PlayerVariable | 選手ごとの可動域・ダイナミックアンカー |
| PeriodLog | 各ピリオド（tick）の状態記録 |

---

## シミュレーションの流れ

### 1. 初期化 (`Initialize`)

1. `GridEvaluator`、ピリオドログリストを生成
2. HOME / AWAY の2チームを生成（各11人）
3. ボール、MatchStateを生成
4. 各Partialクラスをインスタンス化
5. HOMEチームのキックオフをセットアップ

### 2. メインループ (`RunSimulation`)

```
totalPeriods = matchMinutes × PERIODS_PER_MINUTE（0.1秒tick）
```

試合時間分だけ `ProcessPeriod` を繰り返し呼ぶ。

### 3. 1ピリオド（tick）の処理 (`ProcessPeriod`)

```
┌─ 0. トランジション残り時間を進める（攻守凍結のカウントダウン）
│
├─ 1. 攻撃側チーム更新・トランジション判定
│   └─ ボール保持者が切り替わっていたら、ネガティブ/ポジティブトランジション発動
│
├─ 2. 非保持者の行動決定（毎tick）
│   ├─ GK → 専用ロジック（ボール方向へ寄る）
│   └─ FP → ダイナミックアンカー ＋ 味方反発 → 意図座標を更新
│
├─ 2.1 パス飛行中 → 受け手と最寄りの敵を落下点へ誘導
├─ 2.2 ルーズボール → 両チーム最寄り1人をボールへ誘導
│
├─ 3. ボール保持者の行動決定（後述）
│
├─ 4. 全選手が意図座標へ移動（速度ベース、0.1秒tick蓄積方式）
│
├─ 5. 飛行中ボールの進行 → 着地処理
├─ 5.1 ルーズボールの回収判定
│
└─ 6. ピリオド終了時の状態を記録
```

---

## ボール保持者の行動決定 (`ProcessBallHolderAction`)

```
保持者がフリーズ中 → 何もしない

競り合い中 → ドリブル継続

PK待機中 → PKシュート

キックオフ待機中 → キックオフパス

自陣ディフェンスゾーン ＆ 2グリッド以内に敵 → クリア抽選
  └─ クリア確率 ＝ ベース確率 ＋ パス能力ペナルティ

シュート選択（ゴールから16グリッド以内）:
  └─ 視野中央に敵がいなければシュート実行

GK → 必ずパス（ドリブルしない）

デフォルト: ドリブル → パス（フォールバック）
```

---

## 各アクションの詳細

### パス (`TryPass`)

1. `GridEvaluator.EvaluatePass` でパスカット判定
2. **オーバーヒット判定**: パス能力に応じた確率で目標を通り過ぎる
3. **ストレイ判定**: パス能力に応じた確率でズレる
4. 成功 → 受け手の意図座標へボール飛行開始
5. 失敗（インターセプター有り）→ デフレクト or パスカット
6. 失敗（インターセプター無し）→ ルーズボール化
7. ボール速度 = `1 + (passInt / 34)` マス/tick

### シュート (`TryShoot`)

1. **ブロック判定**: シュートコース上の敵を探索（Y距離10以内、X距離6以内）
   - ブロック成功 → ハンドボール ⇒ FK/PK or デフレクト
2. `GridEvaluator.CalcShootSuccessProb` でシュート成功率算出
3. 成功 → ゴール → 相手チームキックオフへリセット
4. 失敗 → GKキャッチ or パリー（弾き）→ ルーズボール

### ドリブル (`TryDribble`)

1. **競り合い継続中**: 残りtickが0になったら決着
   - ドリブルスコア（ドリブル能力 + ランダム）vs 守備スコア（守備能力 + ランダム）
   - 攻撃側敗北 → ファウル判定 / スピル（こぼれ球）/ タックル成功
   - 攻撃側勝利 → 突破1マス前進
2. **新規競り合い開始**: 1グリッド以内に敵 → 0.3〜0.8秒のデュエル開始
3. 前方に空きスペースがあれば1マス前進（視野内ベスト判定）

### クリア (`TryClear`)

- X方向ランダム ± 20、Y方向は自ゴールと逆方向に4〜20グリッド先へ蹴り出し
- ボール速度 = `2 + (speedInt / 40)` マス/tick

### ボール飛行 (`ProcessBallFlight`)

1. 1tickでcellsPerPeriod分だけパス上を前進
2. 各マスで**タッチ判定**: 半径内の選手をスコアリング
   - スコア ＝ 距離ペナルティ ＋ 速度 ＋ 守備 ＋ ランダム ＋ 受け手ボーナス
3. タッチ者が味方 → トラップミス判定 → 成功ならワンタッチパス判定
4. タッチ者が敵 → ハンドボール判定 → インターセプト
5. 到着時に誰も触れなければルーズボール化

### セットプレー

| 種類 | トリガー | 処理 |
|---|---|---|
| スローイン | サイドラインアウト | 最寄りの味方が再開 |
| コーナーキック | ゴールライン（守備側タッチ） | 攻撃側が定位置CK（選手配置変換あり） |
| ゴールキック | ゴールライン（攻撃側タッチ） | 守備側GKが再開 |
| フリーキック | ファウル（非PA内） | ファウル地点から再開 |
| ペナルティキック | ファウル（PA内） | PKスポットからシュート |

---

## ポジショニング

### ダイナミックアンカー

- 基本座標（フォーメーション定義の攻守別座標）にボール位置を加味して動的に算出
- `動的アンカー = ベース座標 + 追従係数 × (ボール位置 - ピッチ中央)`
- 攻撃時は `goalKickOffenseCoordinate`、守備時は `goalKickDefenseCoordinate` をベースに使用
- AWAYチームはベース座標のY軸のみ反転（追従方向は両チーム共通）

### 味方反発 (`ApplyTeammateRepulsion`)

- 味方との距離が6グリッド未満の場合、互いに押し合う
- 近いほど押す力が強くなる

### トランジション（攻守切替）

- **ネガティブトランジション**: ボールロスト側チームの守備行動を一時凍結
- **ポジティブトランジション**: ボール奪取側チームの攻撃行動を一時凍結
- 凍結期間は選手ごとに `PlayerVariable` で定義

---

## グリッド・座標系

- **ピッチサイズ**: `GridEvaluator.WIDTH` × `GridEvaluator.HEIGHT`（1グリッド ≒ 1m）
- HOMEチームは Y=0 が自ゴール側、Y=HEIGHT-1 が攻撃方向
- AWAYチームはY軸反転

---

## ファイル構成

```
MatchSimulator/
├── MatchSimulatorController.cs          ... メインコントローラー（初期化、メインループ、保持者行動）
├── MatchSimulatorController.BallFlight.cs  ... ボール飛行処理
├── MatchSimulatorController.Clear.cs       ... クリア
├── MatchSimulatorController.Dribble.cs     ... ドリブル・競り合い
├── MatchSimulatorController.Helpers.cs     ... 汎用ヘルパー
├── MatchSimulatorController.Kickoff.cs     ... キックオフ
├── MatchSimulatorController.Pass.cs        ... パス
├── MatchSimulatorController.SetPlay.cs     ... セットプレー
├── MatchSimulatorController.Shoot.cs       ... シュート
├── MatchSimulatorDigest.cs                 ... 可視化用ダイジェスト
├── Class/
│   ├── Ball.cs              ... ボール（HOLD/FLYING/LOOSE状態管理）
│   ├── Coordinate.cs        ... 座標クラス
│   ├── FormationData.cs     ... フォーメーション定義
│   ├── FormationSlot.cs     ... スロット（選手の配置枠）
│   ├── GridEvaluator.cs     ... グリッド評価（視野、パス判定、確率）
│   ├── MatchState.cs        ... 試合状態（スコア、攻守管理、トランジション）
│   ├── PeriodLog.cs         ... ピリオドログ
│   ├── Player.cs            ... 選手
│   ├── PlayerProfile.cs     ... 選手プロフィール
│   ├── PlayerStatus.cs      ... 選手ステータス（能力値）
│   ├── PlayerVariable.cs    ... 選手可動域・ダイナミックアンカー
│   ├── PositionDefinition.cs ... ポジション定義
│   └── Team.cs              ... チーム
└── Enum/
    ├── ActionCode.cs        ... 行動コード
    ├── BallStateCode.cs     ... ボール状態コード
    ├── IntentDefenseCode.cs ... 守備意図コード（未使用・将来用）
    ├── IntentHolderCode.cs  ... 保持者意図コード（未使用・将来用）
    ├── IntentOffenseCode.cs ... 攻撃意図コード（未使用・将来用）
    ├── TacticsCode.cs       ... 戦術コード
    └── TeamSideCode.cs      ... チームサイドコード
```
