# 選手の行動パターン（実装まとめ）

このドキュメントは、**現在コードに実装されている選手の行動**を一覧化し、今後の改善時に追記していくためのメモです。

- 時間単位は **period（tick）** を前提（`Consts.PERIOD_MILLISECONDS = 100` → 1period = 0.1秒）
- ログは `PeriodLog`（`holderAction` / `involverAction` など）に記録され、`MatchSimulatorDigest` が再生します

---

## 攻撃（ボール保持者の行動）

| パターン | 発生条件（ざっくり） | 結果 | ログ（PeriodLog） | 主な実装場所 |
|---|---|---|---|---|
| パス成功 | `TryPass()` が成功 | ボールは `FLYING` に移行し落下点へ進む | `holderAction=PASS_SUCCESS` | `MatchSimulatorController.Pass.cs` |
| ワンタッチパス | パス受け直後にワンタッチ分岐が成立 | 即時に次の味方へ再配球（`FLYING`） | `involverAction=ONE_TOUCH_PASS` | `MatchSimulatorController.BallFlight.cs` |
| パス失敗（オーバーヒット/逸れ） | `TryPass()` 内の精度判定で失敗 | ボールは `FLYING` でズレた地点へ、ラインアウトなら再開へ | `holderAction=PASS_FAIL` | `MatchSimulatorController.Pass.cs` / `MatchSimulatorController.BallFlight.cs` |
| パス失敗（DFディフレクト） | カット候補あり + ディフレクト分岐 | DFに当たって進路変更。ラインアウトなら再開へ | `holderAction=PASS_FAIL` `involverAction=PASS_DEFLECT` | `MatchSimulatorController.Pass.cs` / `MatchSimulatorController.BallFlight.cs` |
| クリア | 自陣深い位置 + プレッシャー下でクリア選択 | ロング気味に蹴り出し、ラインアウトの可能性あり | `holderAction=CLEAR` | `MatchSimulatorController.Clear.cs` |
| ドリブル（前進 carry） | 1マス前が空いている | 1マス前進しボール座標も更新 | `holderAction=DRIBBLE_SUCCESS` | `MatchSimulatorController.Dribble.cs` |
| ドリブル競り合い開始 | 近距離（距離1以内）に敵がいる | 数periodかけて決着（その間は実移動しない） | `holderAction=DRIBBLE_SUCCESS` | `MatchSimulatorController.Dribble.cs` / `Player.cs` |
| ドリブル競り合い・勝ち | 競り合い決着で勝つ | 突破扱い→次に前進を試みる | `holderAction=DRIBBLE_SUCCESS` `involverAction=DRIBBLE_BREAKTHROUGH` | `MatchSimulatorController.Dribble.cs` |
| ドリブル競り合い・負け（タックル） | 競り合い決着で負ける | 相手が保持者になる | `holderAction=DRIBBLE_FAIL` `involverAction=TACKLE` | `MatchSimulatorController.Dribble.cs` |
| ドリブル競り合い・こぼれ | 競り合い決着で負け + こぼれ分岐 | ルーズボール化（ライン際ならスローイン/コーナー再開） | `holderAction=DRIBBLE_FAIL` `involverAction=DRIBBLE_SPILL` | `MatchSimulatorController.Dribble.cs` / `MatchSimulatorController.SetPlay.cs` |
| シュート成功（ゴール） | `TryShoot()` 成功 | 得点→`ResetAfterGoal()` で配置リセット | `holderAction=SHOOT_SUCCESS` `hasGoalFlag=true` | `MatchSimulatorController.Shoot.cs` / `MatchSimulatorController.cs` |
| シュート失敗（DFブロック） | シュート時にブロック判定が成立 | こぼれ球/ラインアウト。再開処理へ遷移する場合あり | `holderAction=SHOOT_FAIL` `involverAction=SHOOT_BLOCK` | `MatchSimulatorController.Shoot.cs` / `MatchSimulatorController.SetPlay.cs` |
| シュート失敗（GKキャッチ） | `TryShoot()` 失敗後にGKキャッチ判定が成立 | GKが保持者になる | `holderAction=SHOOT_FAIL` `involverAction=SHOOT_CATCH` | `MatchSimulatorController.Shoot.cs` |
| シュート失敗（GK弾き） | `TryShoot()` 失敗後に弾き判定が成立 | こぼれ球/ラインアウト。再開処理へ遷移する場合あり | `holderAction=SHOOT_FAIL` `involverAction=SHOOT_PARRY` | `MatchSimulatorController.Shoot.cs` / `MatchSimulatorController.SetPlay.cs` |
| シュート時ハンド | ブロック局面でハンド判定が成立 | 笛が鳴ってFK/PKで再開 | `holderAction=HAND` `involverAction=FREE_KICK/PENALTY_KICK` | `MatchSimulatorController.Shoot.cs` / `MatchSimulatorController.SetPlay.cs` |

---

## 守備（ボール非保持者の行動）

※ 現状は「守備行動（タックル等）を自発的に選ぶAI」は未実装で、主に **ボールの飛行・競り合い決着の結果として関与**します。

| パターン | 発生条件（ざっくり） | 結果 | ログ（PeriodLog） | 主な実装場所 |
|---|---|---|---|---|
| インターセプト（途中/到着） | `FLYING` 中に半径内の選手が触る / 到着点で競争に勝つ（敵側） | 敵が保持者になる | `involverAction=INTERCEPT` | `MatchSimulatorController.BallFlight.cs` |
| トラップミス（タッチミス）誘発 | 受け手のトラップ判定が失敗 | 受けた直後にルーズ化（ライン際なら再開） | `involverAction=TRAP_MISS` | `MatchSimulatorController.BallFlight.cs` / `MatchSimulatorController.SetPlay.cs` |
| パス経路でハンド | 受け/カット局面でハンド判定が成立 | 笛が鳴ってFK/PKで再開 | `holderAction=HAND` `involverAction=FREE_KICK/PENALTY_KICK` | `MatchSimulatorController.BallFlight.cs` / `MatchSimulatorController.SetPlay.cs` |
| タックル（競り合い決着） | ドリブル競り合いの決着で守備側が勝つ | 守備側が保持者になる | `involverAction=TACKLE` | `MatchSimulatorController.Dribble.cs` |
| タックルファール | ドリブル競り合い決着でファール判定が成立 | 笛が鳴ってFK/PKで再開 | `holderAction=FOUL` `involverAction=FREE_KICK/PENALTY_KICK` | `MatchSimulatorController.Dribble.cs` / `MatchSimulatorController.SetPlay.cs` |

---

## 攻守の切り替え（トランジション）

| パターン | 発生条件（ざっくり） | 結果 | ログ | 主な実装場所 |
|---|---|---|---|---|
| ネガティブトランジション（保持者ロスト） | 攻守が切り替わった瞬間、ロスト側チームの「直前保持者」 | 一定periodの間、守備の意図更新をしない（守備行動不能） | なし（現状ログには残さない） | `MatchSimulatorController.cs` / `PlayerVariable.cs` |
| ネガティブトランジション（非保持者） | 攻守が切り替わった瞬間、ロスト側チームの「非保持者」 | 保持者より短い期間、守備の意図更新をしない | なし | `MatchSimulatorController.cs` / `PlayerVariable.cs` |
| ポジティブトランジション（保持者） | 攻守が切り替わった瞬間、奪取側チームの「保持者」 | 一定periodの間、攻撃判断を停止（保持しても行動しない） | なし | `MatchSimulatorController.cs` / `PlayerVariable.cs` |
| ポジティブトランジション（非保持者） | 攻守が切り替わった瞬間、奪取側チームの「非保持者」 | 一定periodの間、攻撃意図更新をしない（攻撃行動不能） | なし | `MatchSimulatorController.cs` / `PlayerVariable.cs` |

---

## 共通（移動・意思決定・ボール状態）

| パターン | 発生条件（ざっくり） | 結果 | ログ | 主な実装場所 |
|---|---|---|---|---|
| 意図座標更新（攻撃） | 攻撃側かつ一定間隔で更新 | `intentCoordinate` を更新 | なし | `MatchSimulatorController.cs` / `GridEvaluator.cs` |
| 意図座標更新（守備） | 守備側かつ一定間隔で更新（※ネガティブトランジション中はスキップ） | `intentCoordinate` を更新 | なし | `MatchSimulatorController.cs` / `GridEvaluator.cs` |
| 移動（非保持者） | `MoveToIntent()` | `speedInt` を元に0.1秒tickで座標更新 | period末に `playerCoordinates` | `Player.cs` / `MatchSimulatorController.cs` |
| パス/シュート飛行（FLYING） | `ball.StartFlight()` | 経路を進め、途中タッチ/到着競争で保持者確定 | `involverAction=RECEIVE/INTERCEPT` | `Ball.cs` / `MatchSimulatorController.BallFlight.cs` |
| ラインアウト再開（スローイン/コーナー/ゴールキック） | `FLYING/LOOSE` 中に座標がピッチ外に出る | 最寄り選手（またはGK）が再開位置で保持して再スタート | `involverAction=THROW_IN/CORNER_KICK/GOAL_KICK` | `MatchSimulatorController.SetPlay.cs` |
| 笛の再開（FK/PK） | ファール/ハンドが成立 | 反則地点でFK、PA内ならPKで再開 | `involverAction=FREE_KICK/PENALTY_KICK` | `MatchSimulatorController.SetPlay.cs` |
| キックオフ（テンプレ10→11） | 試合開始/ゴール後の再開時 | センター配置（10番保持）→初手で11番へ固定パス | `holderAction=PASS_SUCCESS`（初手） | `MatchSimulatorController.Kickoff.cs` / `MatchSimulatorController.Pass.cs` |

---

## 追記テンプレ（新しい行動を追加したら）

### 追加した行動名
- **カテゴリ**: 攻撃 / 守備 / トランジション / 共通
- **発生条件**:
- **処理の要点**:
- **ログに残す項目**: `holderAction` / `involverAction` / その他
- **関係する定数**:
- **改善したい点（TODO）**:

---

## 未実装（候補）

- 寄せ（Contain）と奪い（Tackle）の分離
- カバーリング（連動守備）
- クイックリスタート / 遅延リスタート
- 受け直しの種類（足元受け / 裏抜け受け）
- セカンドボール反応差の明示的パラメータ化

